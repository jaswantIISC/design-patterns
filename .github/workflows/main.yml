name: CI on Push

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
        issues: write
        contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue reference
        id: issue
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          REF=$(echo "$COMMIT_MSG" | sed -E '
            s|^https://github.com/([^/]+/[^/]+)/issues/([0-9]+).*|\1#\2|;
            s|^([a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+#[0-9]+).*|\1|;
            s|^#([0-9]+).*|'"$GITHUB_REPOSITORY"'#\1|;
          ')

          echo "issue=$REF" >> "$GITHUB_OUTPUT"

      - name: Reopen issue if closed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ steps.issue.outputs.issue %\#* }}"
          ISSUE="${{ steps.issue.outputs.issue ##*\# }}"

          STATE=$(gh api repos/$REPO/issues/$ISSUE --jq '.state' 2>/dev/null || echo "not_found")

          if [ "$STATE" = "closed" ]; then
            gh api -X PATCH repos/$REPO/issues/$ISSUE -f state=open
            gh api -X POST repos/$REPO/issues/$ISSUE/comments \
              -f body="ðŸ”„ Reopened due to commit https://github.com/${{ github.repository }}/commit/${{ github.sha }} by @${{ github.actor }}"
            gh api -X POST repos/${{ github.repository }}/issues/$ISSUE/labels -f labels[]="reopened by new commit"  
          fi
