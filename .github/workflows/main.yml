name: CI on Push

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run validation
        run: |
          echo "Code pushed or PR created"
          # add build / test / lint commands here

      - name: Extract issue numbers from commit message
        id: issues
        run: |
          ISSUES=$(git log -1 --pretty=%B \
            | grep -oE '#[0-9]+' \
            | tr -d '#' \
            | sort -u | tr '\n' ' ')

          echo "issues=$ISSUES" >> $GITHUB_OUTPUT  
        
      - name: Exit if no issues referenced
        if: steps.issues.outputs.issues == ''
        run: echo "No issue references found."

      - name: Reopen closed issues and comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for ISSUE in ${{ steps.issues.outputs.issues }}; do
            echo "Checking issue #$ISSUE"

            STATE=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.state' || echo "not_found")

            if [ "$STATE" = "closed" ]; then
              echo "Reopening issue #$ISSUE"

              # Reopen issue
              gh api \
                -X PATCH \
                repos/${{ github.repository }}/issues/$ISSUE \
                -f state=open

              # Add comment
              gh api \
                -X POST \
                repos/${{ github.repository }}/issues/$ISSUE/comments \
                -f body="ðŸ”„ This issue was automatically reopened because a new commit referenced it.\n\nCommit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}\nAuthor: @${{ github.actor }}"
            else
              echo "Issue #$ISSUE is not closed (state=$STATE)"
            fi
          done

      - permissions:
        issues: write
        contents: read